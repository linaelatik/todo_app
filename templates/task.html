{% extends 'base.html' %}

{% block title %}{{ item.content }} - Hierarchical Todo List{% endblock %}

{% block content %}
<div class="task-view">
    <div class="task-header">
        <div class="breadcrumb">
            <a href="{{ url_for('dashboard') }}">Dashboard</a> &gt;
            <a href="{{ url_for('view_list', list_id=item.list_id) }}">{{ item.todo_list.title }}</a>
            {% for parent in parent_chain %}
                &gt; <a href="{{ url_for('view_task', item_id=parent.id) }}">{{ parent.content }}</a>
            {% endfor %}
        </div>
        
        <div class="task-title">
            <h2>
                <span class="task-status {% if item.completed %}completed{% endif %}">
                    <a href="{{ url_for('toggle_item', item_id=item.id) }}" class="toggle-item">
                        <i class="fas {% if item.completed %}fa-check-square{% else %}fa-square{% endif %}"></i>
                    </a>
                </span>
                {{ item.content }}
            </h2>
            <button id="edit-task-btn" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Rename
            </button>
        </div>
        
        <div class="task-meta">
            <p>Level: {{ item.level }}</p>
            <p>Created: {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% if item.parent %}
                <p>Parent: <a href="{{ url_for('view_task', item_id=item.parent.id) }}">{{ item.parent.content }}</a></p>
            {% endif %}
        </div>
    </div>
    
    <!-- Edit Task Name Form (initially hidden) -->
    <div id="edit-task-form" class="edit-task-form" style="display: none;">
        <form method="POST" action="{{ url_for('update_task', item_id=item.id) }}">
            <div class="form-group">
                <label for="task-content">Task Name</label>
                <input type="text" id="task-content" name="content" value="{{ item.content }}" required>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" id="cancel-edit-task" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Add Subtask Form -->
    <div class="add-subtask-section">
        <h3>Add Subtask</h3>
        <form method="POST" action="{{ url_for('new_item') }}" class="new-item-form">
            <input type="hidden" name="list_id" value="{{ item.list_id }}">
            <input type="hidden" name="parent_id" value="{{ item.id }}">
            <div class="form-group">
                <input type="text" name="content" placeholder="Enter subtask..." required>
                <button type="submit" class="btn btn-success">Add</button>
            </div>
        </form>
    </div>
    
    <!-- Subtasks Section -->
    <div class="subtasks-container">
        <div class="subtasks-header">
            <h3>Subtasks</h3>
            {% if item.children %}
                <a href="{{ url_for('toggle_collapse', item_id=item.id) }}" class="btn btn-sm btn-secondary">
                    <i class="fas {% if item.collapsed %}fa-eye{% else %}fa-eye-slash{% endif %}"></i>
                    {% if item.collapsed %}Show All{% else %}Hide All{% endif %}
                </a>
            {% endif %}
        </div>
        
        {% if item.children and not item.collapsed %}
            <ul class="subtasks-list">
                {% for child in item.children %}
                    <li class="subtask-item {% if child.completed %}completed{% endif %}">
                        <div class="subtask-content">
                            <div class="subtask-main">
                                <div class="subtask-checkbox">
                                    <a href="{{ url_for('toggle_item', item_id=child.id) }}" class="toggle-item">
                                        <i class="fas {% if child.completed %}fa-check-square{% else %}fa-square{% endif %}"></i>
                                    </a>
                                </div>
                                <div class="subtask-text">{{ child.content }}</div>
                                {% if child.children %}
                                    <span class="subtask-count">
                                        <i class="fas fa-tasks"></i> {{ child.children|length }}
                                    </span>
                                {% endif %}
                            </div>
                            <div class="subtask-actions">
                                <a href="{{ url_for('view_task', item_id=child.id) }}" class="btn btn-sm btn-secondary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_item', item_id=child.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this subtask?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% elif item.children and item.collapsed %}
            <div class="collapsed-notice">
                <p>{{ item.children|length }} subtasks are hidden</p>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-tasks"></i>
                <p>No subtasks yet.</p>
                <p>Add your first subtask above!</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Task Actions -->
    <div class="task-actions">
        <a href="{{ url_for('view_list', list_id=item.list_id) }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
        <a href="{{ url_for('delete_item', item_id=item.id) }}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this task and all its subtasks?')">
            <i class="fas fa-trash"></i> Delete Task
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit task name functionality
        const editTaskBtn = document.getElementById('edit-task-btn');
        const editTaskForm = document.getElementById('edit-task-form');
        const cancelEditTask = document.getElementById('cancel-edit-task');
        
        editTaskBtn.addEventListener('click', function() {
            editTaskForm.style.display = 'block';
            editTaskBtn.style.display = 'none';
        });
        
        cancelEditTask.addEventListener('click', function() {
            editTaskForm.style.display = 'none';
            editTaskBtn.style.display = 'inline-block';
        });
        
        // Add toggle functionality for task completion
        const toggleLinks = document.querySelectorAll('.toggle-item');
        toggleLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const itemId = this.closest('a').href.split('/').pop();
                
                fetch(`/item/${itemId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update icon
                        const icon = this.querySelector('i');
                        if (data.completed) {
                            icon.className = 'fas fa-check-square';
                            this.closest('.task-status, .subtask-item').classList.add('completed');
                        } else {
                            icon.className = 'fas fa-square';
                            this.closest('.task-status, .subtask-item').classList.remove('completed');
                        }
                        
                        // Reload page to show updated subtasks
                        window.location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
{% endblock %}

